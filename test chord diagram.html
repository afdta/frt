<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<!--<link href='http://fonts.googleapis.com/css?family=Ubuntu:300,400,700,300italic,400italic|Ubuntu+Condensed' rel='stylesheet' type='text/css'>-->
<style>

body{
  max-width:1100px;
  width:100%;
  position:relative;
  margin: 0px auto 0px auto;
  font-size:16px;
}

h1,h2,h3,p,a{font-family:ubuntu,arial,sans;margin:1.25em 0px 0.25em 6px;line-height:1.5em;}
a{margin-left:0px;}


li{margin:0.5em 0px 0.25em 0px;font-family:ubuntu,arial,sans;font-weight:300;font-style:italic;line-height:1.5em;}
li:first-child{margin-top:0px;}
ul{width:80%;margin:0.5em 0px 0.5em 0px;}

h3+p{margin-top:0.5em;}

img{
  width:auto;
  height:auto;
}

div.divider{
  width:50px;
  height:2em;
  margin-left:6px;
  margin-bottom:12px;
  border-bottom:1px solid #d1d1d1;
}

div.section{
  width:100%;
  margin-top:2em;
  border-top:1px solid #888888;
}


path.chord {
  pointer-events:none;
}

text{
  font-family:"ubuntu condensed";
  font-size:13px;
  fill:#333333;
  pointer-events:none;
}

text.label{
  pointer-events:auto;
  cursor:pointer;
}

svg{
  margin-left:7px;
}

ul.todo li{
  color:rgb(150,150,150);
}

</style>
<body>

<h1>Freight Networks</h1>
<p style="color:red;">DRAFT - DO NOT CITE OR REPRODUCE</p>

<div class="section">
  <h3>What Does The Network Look Like?</h3>
  <p>Click on the Perimeter of the Circle to View Flows To/From a Single Market</p>
  <div class="divider"></div>
  <svg class="mainSVG">
    <defs>
      <radialGradient id="chordGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
        <stop offset="20%" stop-color="#ffffff" stop-opacity="0"></stop>
        <stop offset="80%" stop-color="#ffff00" stop-opacity="1"></stop>
      </radialGradient>

      <mask id="masking">
        <circle cx="0" cy="0" r="320px" fill="url(#chordGradient)"></circle>
      </mask>
    </defs>
  </svg>
</div>

<div class="section">
  <h3>Who Does My Metro Area Trade With?</h3>
  <p>Select a metro area to view its top trading partners</p>
  <select id="metroSelect"></select>
  <div class="divider"></div>
  <p id="myMetroFlowTitle">Top 50 Trading Partners By Total Dollar Value</p>
  <svg id="metroFlows"></svg>
</div>

<div class="section">
  <p>To do:</p>
  <ul class="todo">
    <li>Revise/simplify color scheme</li>
    <li>Improve interactions (e.g. selection of metros on the chord--top--diagram)</li>
    <li>Make the drawing of lines on the chord diagram snappier</li>
    <li>Add commodity data</li>
    <li>Ensure that subtransitions do not collide -- review D3 source</li>
    <li>Provide data-annotations upon selecting/hovering over a place</li>
    <li>Revise area names (include state names in the title, and swap "rest of" for something else)</li>
  </ul>
</div>

<!--<script src="http://d3js.org/d3.v3.min.js"></script>-->
<script src="d3v3dot4.js"></script>
<script>

var colors = d3.scale.category20().domain([1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20])
var xwalk = {
  WSC:{name:"West South Central",dg:"Domestic",indx:1},
  ESC:{name:"East South Central",dg:"Domestic",indx:2},
  SA:{name:"South Atlantic",dg:"Domestic",indx:3},
  NE:{name:"Northeast",dg:"Domestic",indx:5},
  ENC:{name:"East North Central",dg:"Domestic",indx:6},
  WNC:{name:"West North Central",dg:"Domestic",indx:7},
  MO:{name:"Mountain",dg:"Domestic",indx:8},
  PA:{name:"Pacific",dg:"Domestic",indx:9},
  AS:{name:"Asia",dg:"Global",indx:10},
  EU:{name:"Europe",dg:"Global",indx:11},
  AF:{name:"Africa",dg:"Global",indx:12},
  LA:{name:"Americas",dg:"Global",indx:13},
  OTHER:{name:"Aggregate of Remaining Flows",dg:"Both",indx:16}
}
var xwalkLeg = ["WSC","ESC","SA","NE","ENC","WNC","MO","PA","AS","EU","AF","LA"];


d3.json("metflows/bigMatrix.json",function(error,data){
  var matrix = data.data;
  var dLabels = data.places;
  var focus = 33; //set to current metro focus index -- insures all cords are colored according to where they came from
  var chord = d3.layout.chord()
    .padding(.01)
    //.sortGroups(d3.descending)
    //.sortSubgroups(d3.descending)
    .sortChords(d3.ascending)
    .matrix(matrix);

var width = 1000,
    height = 1000,
    innerRadius = Math.min(width, height) * .28,
    outerRadius = innerRadius * 1.05;

var fill = function(i){
  var region = dLabels[i].CensusDiv;
  var col = colors(xwalk[region].indx);
  return region ? col : "#d1d1d1";
}

/*var fill = function(s,t){
  if(!t){
    //var region = s!==focus ? dLabels[s].CensusDiv : null;
    var region = dLabels[s].CensusDiv;
  } else{
    var r1 = dLabels[s].CensusDiv;
    var r2 = dLabels[t].CensusDiv;
    if(r1 in {"AS":1,"EU":1,"AF":1,"LA":1,"OTHER":1}){
      var region = dLabels[s].CensusDiv;
    }
    else if(r2 in {"AS":1,"EU":1,"AF":1,"LA":1,"OTHER":1}){
      var region = dLabels[t].CensusDiv;
    }
    else if(s===focus){
      var region = dLabels[t].CensusDiv;
    }
    else{
      var region = dLabels[s].CensusDiv;
    }
  }
  var col = colors(xwalk[region].indx);
  //console.log(r2 + " " + r1 + " " + col)
  return region ? col : "#d1d1d1";
}*/

/*var fill = function(i){
  if(i<=124){
    var t = i/124;
    var I = d3.interpolateRgb("#0119FF","#98DAF7");
  }
  else{
    var t = (i%124)/24;
    var I = d3.interpolateRgb("#46B209","#C0FFA4");
  }
  return I(t);
}*/
  /*d3.scale.ordinal()
    .domain(d3.range(4))
    .range(["#000000", "#FFDD89", "#957244", "#F26223"]);
  }*/

var SVG = d3.select("svg.mainSVG")
    .attr("width", width+50)
    .attr("height", height+50)

//var back = SVG.append("rect").attr({"x":"0","y":"0","width":width,"height":height}).style("fill","#000000").attr("mask","url(#masking)");

var svg = SVG.append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

var title = d3.select("svg.mainSVG").append("text").attr({"x":"0","y":15})
  .text("Value of Trade Between U.S. and International Markets").style("font-size","18px")
var subtitle = d3.select("svg.mainSVG").append("text").attr({"x":"0","y":34})
  .text("Showing the 75 largest U.S. markets and 25 largest international markets according to their total bilateral trade with other U.S. markets in 2010")
  //.text("Showing the value of trade between the New York Metro area and all Other Markets, 2010")

var legend = d3.select("svg.mainSVG").append("g").attr("transform","translate(0,"+100+")");
legend.append("text").attr({"x":"5","y":"-14"}).text("Broad Geographic Regions").style("text-decoration","underline").style("font-size","15px")
var legendEntries = legend.selectAll("g").data(xwalkLeg).enter().append("g").attr("transform",function(d,i){
  return "translate(0," + i*22 + ")"
});
legendEntries.append("rect")
  .attr({"x":"5","y":"0","width":"12","height":"12"})
  .style("fill",function(d,i){return colors(xwalk[d].indx)})
legendEntries.append("text")
  .attr({"x":20,"y":11})
  .text(function(d,i){return(xwalk[d].dg + " - " +xwalk[d].name)});

var groups = svg.append("g").selectAll("g").data(chord.groups).enter().append("g");

var arcs = groups.append("path")
    .style("fill", function(d) { return fill(d.index); })
    //.style("stroke", function(d) { return fill(d.index); })
    .style("stroke-width","0px")
    .style("stroke","#ffffff")
    .attr("d", d3.svg.arc().innerRadius(innerRadius).outerRadius(outerRadius))
    .on("mousedown", groupHover)
    .on("mouseup", function(){
      d3.select(this).style("opacity",1);
    })

var labels = groups.append("g").datum(grouping).attr("transform", function(d) {
      return "rotate(" + d.rot + ")" + "translate(" + outerRadius + ",0)";
    });

// Returns an event handler for fading a given chord group.
//var cache = {}; //doesn't really improve performance
var CURRENT; 
var onOff;
function groupHover(d) {
    d3.select(this).style("opacity",0.66);
    var CHORDS = d3.selectAll("path.chord");
    CHORDS.style("display","none");
    d3.event.stopPropagation();
    var I = d.index;
    clearTimeout(onOff);
    onOff = setTimeout(function(){
      if(CURRENT){CURRENT.style("opacity",0)}
      CURRENT = CHORDS.filter(function(d) {return d.source.index === I || d.target.index === I; })
                   //.style("opacity",1)
                   .style("fill",function(d){
                      return d.source.index===I ? fill(d.target.index) : fill(d.source.index);
                   })
                   .attr("stroke", function(d){
                      return d.source.index===I ? fill(d.target.index) : fill(d.source.index);
                    })
                    .style("stroke-width","0.5px") //any stroke and you can't see much variation
                    .style("opacity",function(d,i){
                      //if(d.source.index!==2 && d.target.index!==2){return 0}
                      var ratio = (d.source.value/10000) + 0.15;
                      return ratio > 1 ? 1 : ratio;
                      //return 1;
                    });
                    
                    CHORDS.style("display","inline");
                    },10)
      
    /*if(I in cache){
      cache[I].style("opacity",0);
    }
    else{
      cache[I] = svg.selectAll("path.chord").filter(function(d) { return d.source.index !== I && d.target.index !== I; })
      cache[I].style("opacity",0)
    }*/
};

function groupRestore(d) {
    clearTimeout(onOff);
    //d3.select(this).style("opacity",1);
    d3.event.stopPropagation();
    //svg.selectAll("path.chord").style("opacity", 1);
};

//console.log(groups);

// calculate labels, positions, and label rotation
function grouping(d) {
  var pos = d.endAngle - ((d.endAngle - d.startAngle)/2);
  var deg = (pos * 180 / Math.PI)
  var rot = deg-90;
  return {rot:rot,deg:deg}
}


labels.append("text")
    .attr("x", 8)
    .attr("dy", "0.25em")
    .attr("transform", function(d) { return d.deg > 180 ? "rotate(180)translate(-16)" : null; })
    .style("text-anchor", function(d) { return d.deg > 180 ? "end" : null; })
    .style("font-size","12px")
    .text(function(d,i) { return dLabels[i].Geo_Description; });

var r2o = d3.interpolateRgb("#d7dde8","#757f9a");

svg.append("g")
    .attr("class", "chord")
    //.attr("mask","url(#masking)")
  .selectAll("path")
    .data(chord.chords)
  .enter().append("path")
    .attr("d", d3.svg.chord().radius(innerRadius))
    .attr("class","chord")
    .attr("fill", function(d){
      var r = d.source.value/20000;
      return r>=1 ? r2o(1) : r2o(r);
    })
    .style("stroke-width","0px")
    //.style("stroke","blue")
    /*.style("fill-opacity",function(d,i){
      //if(d.source.index!==2 && d.target.index!==2){return 0}
      var ratio = (d.source.value/10000) + 0.55;
      return ratio > 1 ? 1 : ratio;
      //return 1;
    })*/
    /*.on("mouseover",function(d,i){
      d3.select("#source-val").text(d.source.value + " (" + d.source.index + " | " + d.source.subindex + ")");
      d3.select("#target-val").text(d.target.value + " (" + d.target.index + " | " + d.target.subindex + ")");
    });*/

svg.append("circle").attr({"cx":"0","cy":"0",r:innerRadius}).style({"stroke-width":"3px","stroke":"#ffffff","fill":"none"})

CURRENT = svg.selectAll("path.chord");
/*var onOff;
back.on("mouseover",function(){
  clearTimeout(onOff);
  onOff = setTimeout(function(){allChords.style("opacity",0)},300);
});*/

})

var SVGDetail = d3.select("#metroFlows");
var gPaths = SVGDetail.append("g");
var gTexts = SVGDetail.append("g");
var ready = false;
var selectedMetro = null;
var selectMenu;
var index;
var flowCache = {};
var metroFlow;
var H = 1000;
var W = 750;
var SPACE = 5;

SVGDetail.attr("height",H).attr("width",W+450);

var dataTransform = function(flow){
  //summary data
  var newH = H - (SPACE*flow.length);
  var range = d3.extent(flow,function(d,i,a){return d.val});
  var sum = d3.sum(flow,function(d,i,a){return d.val});
  var max = range[1];
  var Y = d3.scale.linear().domain([0,1]).range([0,newH]);  
  var cum = 0;
  //function to transform each element
  var mapper = function(d,i,a){
    var h = Y(d.val/sum);
    var b = cum; 
    cum = cum + h + SPACE;
    var col = colors(xwalk[d.div].indx);
    return {nm:d.nm, div:d.div, val:d.val, height:h, top:b, bot:cum, col:col, pos:i*3}; 
  }

  return flow.map(mapper);
}

var iter = 0;
var UPDATE = function(){

    var i = selectMenu.node().selectedIndex;
    selectedMetro = index[i];
    var code = selectedMetro.Geo_ID;
    var nm = selectedMetro.Geo_Description;

    d3.select("p#myMetroFlowTitle").text("Top 50 Trading Partners of " + nm);

  if(code in flowCache){
    metroFlow = flowCache[code];
    ILLUSTRATE(metroFlow);
  }
  else{
    d3.json("metflows/"+code+".json",function(error,data){
      if(error){
        metroFlow = null;
      } else{
        cum = 0;
        metroFlow = dataTransform(data);
        flowCache[code] = metroFlow;
      }
      ILLUSTRATE(metroFlow);
    })
  }

  try{
    var CDCol = colors(xwalk[index.filter(function(d,i,a){return d.Geo_ID===code})[0].CensusDiv].indx);
  }
  catch(e){
    var CDCol = "#d1d1d1";
  }
  var focus = SVGDetail.selectAll("rect#focusMetro").data([null]);
  focus.exit().remove();
  focus.enter().append("rect").attr("id","focusMetro").attr({"x":"5","y":"0","width":"43","height":"152"});
  focus.style("fill",CDCol);
}

var ILLUSTRATE = function(flow){
  /*console.log("Illustrate")
  //test -- generate random data
  var R = {flows:[]}
  for(var i=0;i<30;i++){
    R.flows.push({name:"Flow "+i,value:Math.random()*1000})
  }
  R.flows.sort(function(a,b){
    return b.value-a.value;
  })*/

  if(!flow){
    alert("Data error, reload.")
    return;
  }

  //var update = SVGDetail.selectAll("g.flowGroup").data(flow,function(d,i){return d.nm});
  //update.exit().remove();//.transition().duration(1000).style("opacity","0").remove();
  //update.enter().append("g");
  //update.attr("class","flowGroup");
  
  //var flow = update.selectAll("g.flow").data(function(d,i){
    /*var h = Y(d.val/sum);
    var b = cum; 
    cum = cum + h + SPACE;
    var col = colors(xwalk[d.div].indx);*/
    //return [d];
  //});
  //flow.exit().remove();
  //flow.enter().append("g");
  //flow.attr("class","flow");

  //Bezier curve parameters  
  var xLeft = 50;
  var xRight = 800;
  var x0 = Math.round((xRight-xLeft)/2);
  var x1 = x0;

  var mergeFunc = function(d,i){return d.nm} 
  var basePath = function(sourceY){
    sourceY = !!sourceY ? sourceY : 150;
    var s = "M" + xLeft + "," + sourceY +
          "C" + x0 + "," + sourceY + 
          " " + x1 + "," + (H-5) + 
          " " + xRight + "," + (H-5) +
          "l0" + "," + 5 +
          "C" + x1 + "," + H +
          " " + x0 + "," + sourceY + 
          " " + xLeft + "," + sourceY ;
    return s;
  }  

  var flows = gPaths.selectAll("path.flow").data(flow,mergeFunc);
  flows.exit().transition().duration(1000).attr("d",basePath()).remove();
  flows.enter().append("path").attr("class","flow")
    .style({"stroke-width":"1px","stroke":"#ffffff","fill":"#ffffff"})
    .attr("d",function(d){
      return basePath();
    }).style("fill",function(d,i){
      return d.col;
    })
    .style("stroke",function(d,i){
      return d.col;
    });//baseline styles only get applied to entering selection -- which is every node at some point

  //SVGDetail.selectAll("text.inactive").remove();
  ++iter;
  var text = gTexts.selectAll("text.label").data(flow,mergeFunc);
  text.exit().transition().delay(0).duration(1000).attr("y",H).style("fill","#ffffff").remove();
  
  text.enter().append("text").attr("class","label")
    .style({"opacity":"0"})
    .style("fill",function(d,i){return d.col})
    .attr({"x":xRight+30,y:H})
    .text(function(d){
      return d.nm;
    });

  /*text.text(function(d,i){
    return i<50 ? d.nm + " (ITER" + iter + ")" : d.nm;
  })*/

  text.on("mousedown",function(d,i){
    var nm = d.nm;
    var f = index.filter(function(d,i,a){
      return d.Geo_Description === nm;
    })
    var currentIndex = selectMenu.node().selectedIndex;
    try{
      var I = index.indexOf(f[0]);
      selectMenu.node().selectedIndex = I;
      UPDATE();
    } 
    catch(e){
      selectMenu.node().selectedIndex = currentIndex; //reverse any change
      UPDATE();
    }
  })


  flows.transition().delay(0).duration(1500)
  .attr("d",function(d,i){;
    var sourceY = d.pos;
    var s = "M" + xLeft + "," + sourceY +
            "C" + x0 + "," + sourceY + 
            " " + x1 + "," + d.top + 
            " " + xRight + "," + d.top +
            "l0" + "," + d.height +
            "C" + x1 + "," + d.bot +
            " " + x0 + "," + sourceY + 
            " " + xLeft + "," + sourceY ;
    return s;
  })

  //console.log(text)

  var t0 = text.transition().delay(0).duration(1500)
  .style("opacity","1")
  .attr("y",function(d,i){
    if(i==0){console.log(JSON.stringify(this.__transition__))}
    return d.top+0.5*d.height+6;
  })

  var t1 = t0.transition().ease("bounce").duration(500)
  .style("fill","#333333")
  .attr("x",function(d,i){
    if(i==0){console.log(JSON.stringify(this.__transition__))}
    return xRight+10
  })
  
  /*.each("end",function(d,i){
    console.log(this);
    var e = d3.select(this);
    //if(e.classed("new-label")){
      e.transition().duration(700).style("fill","#333333").attr("x",xRight+10);
      e.classed("new-label",false);
    //}
  })*/
  ;
  /*.each("end",function(){
    var thiz = this;
      d3.select(this).transition().attr("x",xRight+20).each("end",function(){
        d3.select(this).transition().attr("x",xRight+10)
      });
      //d3.select(thiz).style("fill","#505050");
  })*/

}



d3.json("metflows/index.json",function(error,data){
  if(data){
    index = data;
    selectMenu = d3.select("#metroSelect");

    selectMenu.selectAll("option").data(index).enter().append("option")
    .attr("value",function(d){
      return d.Geo_ID;
    })
    .text(function(d){
      return d.Geo_Description;
    })

    ready = true;
    UPDATE();

    selectMenu.on("change",function(d,i){
      UPDATE();
    })

  }
})

</script>

</body>
</html>