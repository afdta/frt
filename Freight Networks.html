<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<script src="jquery111min.js"></script>
<style>

body{
  max-width:950px;
  width:100%;
  position:relative;
  margin: 0px auto 0px auto;
  font-size:15px;
}

#FNWrap h3, #FNWrap p, #FNWrap a{font-family:arial,sans;margin:1em 0px 0.25em 0px;line-height:1.5em;}
#FNWrap select, #FNWrap select option{font-size:13px;}

#FNWrap text{
  font-family:"arial";
  font-size:12px;
  fill:#333333;
  pointer-events:none;
  user-select:none;
}

#FNWrap text.grayNote{
  fill:rgb(100,100,100);
  font-style:italic;
  font-size:11px;
}

#FNWrap p.grayNote{
  color:rgb(150,150,150);
  font-style:italic;
  font-size:13px;
  margin:0px 20px 20px 0px;
}

#FNWrap text.gray100{
  fill:rgb(100,100,100);
}

#FNWrap text.label{
  font-size:12px;
  pointer-events:none;
  line-height:12px;
  dominant-baseline:middle;
}

#FNWrap g.borderLabel text{
  fill:rgb(100,100,100);
}

#FNWrap path.selectable, #FNWrap text.selectable, #FNWrap path.borderArc{
  cursor:pointer;
  pointer-events:auto;
}

#FNWrap line, #FNWrap rect{
  shape-rendering:crispEdges;
}

#FNWrap svg#mainSVG{
  margin-left:-20px;
}

/*#slider{
  -webkit-transition: left 0.5s ease;
  -moz-transition: left 0.5s ease;
  -o-transition: left 0.5s ease;
  transition: left 0.5s ease;
}*/

</style>
<body>

<div id="FNWrap" style="border-bottom:1px solid #d1d1d1">

    <div style="width:950px;">
      <h3 id="chordDiagramTitle"></h3>
      <div style="width:100%;border-bottom:1px solid #d1d1d1;display:table;padding-bottom:5px;">
        <div style="display:table-row;vertical-align:bottom">
          <div style="display:table-cell;vertical-align:bottom;width:70%">
            <p style="margin:10px 0px 0px 0px;vertical-align:bottom;" id="chordDiagramText"></p>
          </div>
          <div style="display:table-cell;vertical-align:bottom;width:30%">
            <div style="margin:5px 0px 0px 0px;">
              <p style="text-align:right;font-size:11px;text-transform:uppercase;color:rgb(100,100,100)">Select a Commodity Group</p>
              <select style="float:right;margin:0px 0px 6px 0px;" id="commSelect1"></select>
            </div>
          </div>
        </div>
      </div> 

    </div>

    <svg id="mainSVG">
      <defs>
        <radialGradient id="chordGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
          <stop offset="20%" stop-color="#ffffff" stop-opacity="0"></stop>
          <stop offset="80%" stop-color="#ffff00" stop-opacity="1"></stop>
        </radialGradient>

        <linearGradient id="buttonGradient">
          <stop offset="0%" stop-color="#ffffff" stop-opacity="1"></stop>
          <stop offset="5%" stop-color="#ffffff" stop-opacity="0.2"></stop>
          <stop offset="50%" stop-color="#57bbFF" stop-opacity="0.3"></stop>
          <stop offset="95%" stop-color="#ffffff" stop-opacity="0.2"></stop>
          <stop offset="100%" stop-color="#ffffff" stop-opacity="1"></stop>
        <linearGradient>

        <mask id="masking">
          <circle cx="0" cy="0" r="320px" fill="url(#chordGradient)"></circle>
        </mask>
      </defs>
      <g id="chordDiagram">
        <g id="cdChords"></g>
        <g id="cdArcs"></g>
        <g id="cdAnno"></g>
      </g>
      <g id="legendGroup"></g>
      <g id="chordClickDirection"></g>
      <g id="chordResetButton">
        <rect></rect>
        <path></path>
        <line></line>
        <text></text>
      </g>
    </svg>
    <div>
      <p class="grayNote">The data presented in this interactive feature identify the following market geographies: 361 U.S. metropolitan areas, 48 state "remainders" (i.e the non-metropolitan portion of each state), 18 countries, 11 country groups (e.g. Eastern Europe, Northern Africa, and the Caribbean), and 11 "remainders" of these country groups (DEFINE THIS). Both state and country group remainders are identified by "(Rem.)" following their name.</p>
    </div>
    
    <div style="width:950px;padding-top:30px;border-top:1px dotted #d1d1d1">
      <h3 id="myMetroFlowTitle"></h3>
      <div style="width:100%;border-bottom:1px solid #d1d1d1;display:table; padding-bottom:5px;">
        <div style="display:table-row;vertical-align:bottom">
          <div style="display:table-cell;vertical-align:bottom;width:50%;padding-right:1%">
            <p style="margin:5px 0px 0px 0px;vertical-align:bottom;" id="myMetroFlowText"></p>
          </div>

          <div style="display:table-cell;vertical-align:bottom;width:23%">
            <div style="margin:10px 0px 0px 0px;">
              <p style="text-align:right;font-size:11px;text-transform:uppercase;color:rgb(100,100,100)">Select a Commodity Group</p>
              <select style="float:right;margin:0px 0px 6px 0px;" id="commSelect2"></select>
            </div>
          </div>

          <div style="display:table-cell;vertical-align:bottom;width:23%">
            <div style="margin:10px 0px 0px 0px;">
              <p style="text-align:right;font-size:11px;text-transform:uppercase;color:rgb(100,100,100)">Select a Geography</p>
              <select style="float:right;margin:0px 0px 6px 0px;" id="metroSelect"></select>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div id="flowDiagramWrap" style="position:relative">
      <svg id="flowDiagram">
        <defs>
          <linearGradient id="linGradient">
            <stop offset="0%" stop-color="#ffffff" stop-opacity="0.8"></stop>
            <stop offset="70%" stop-color="#ffffff" stop-opacity="0.8"></stop>
            <stop offset="100%" stop-color="#ffffff" stop-opacity="0.6"></stop>
          <linearGradient>

          <linearGradient id="linGradient2" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ffffff" stop-opacity="0.9"></stop>
            <stop offset="60%" stop-color="#ffffff" stop-opacity="0.8"></stop>
            <stop offset="100%" stop-color="#ffffff" stop-opacity="0.6"></stop>
          <linearGradient>

          <mask id="linMask">
            <rect x="0" y="19" width="90" height="40" fill="url(#linGradient2)"></rect> 
          </mask>

        </defs>
      </svg>
      <div id="flowToolTip"></div>
    </div> 
  </div>

<!--<script src="/~/media/multimedia/interactives/2014/FreightNetworks/d3v3dot4.js"></script>-->
<script src="d3v3dot4.js"></script>
<script>

var DATAREPO = "/~/media/multimedia/interactives/2014/FreightNetworks/json/"
var DATAREPO = "json/";

//var colors = d3.scale.category20().domain([1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20])
/*var xwalk = {
  WSC:{name:"West South Central",dg:"Domestic",indx:1},
  ESC:{name:"East South Central",dg:"Domestic",indx:2},
  SA:{name:"South Atlantic",dg:"Domestic",indx:3},
  NE:{name:"Northeast",dg:"Domestic",indx:5},
  ENC:{name:"East North Central",dg:"Domestic",indx:6},
  WNC:{name:"West North Central",dg:"Domestic",indx:7},
  MO:{name:"Mountain",dg:"Domestic",indx:8},
  PA:{name:"Pacific",dg:"Domestic",indx:9},
  AS:{name:"Asia",dg:"Global",indx:10},
  EU:{name:"Europe",dg:"Global",indx:11},
  AF:{name:"Africa",dg:"Global",indx:12},
  LA:{name:"Americas",dg:"Global",indx:13},
  OTHER:{name:"Aggregate of Remaining Flows",dg:"Both",indx:16}
}
var xwalkLeg = ["WSC","ESC","SA","NE","ENC","WNC","MO","PA","AS","EU","AF","LA"];*/

var colors = d3.scale.ordinal().domain([1,2,3,4,5,6,7,8,9]).range(["#0962ba","#579eff","#2cd1ad","#18705d","#fb9524","#ab4811","#6d468f","#b976f2","#d1d1d1"])
var xwalk = {
  WSC:{name:"South",dg:"U.S.",indx:1},
  ESC:{name:"South",dg:"U.S.",indx:1},
  SA:{name:"South",dg:"U.S.",indx:1},
  NE:{name:"Northeast",dg:"U.S.",indx:2},
  ENC:{name:"Midwest",dg:"U.S.",indx:3},
  WNC:{name:"Midwest",dg:"U.S.",indx:3},
  MO:{name:"West",dg:"U.S.",indx:4},
  PA:{name:"West",dg:"U.S.",indx:4},
  AS:{name:"Asia",dg:"Global",indx:5},
  EU:{name:"Europe",dg:"Global",indx:6},
  AF:{name:"Africa",dg:"Global",indx:7},
  LA:{name:"Americas",dg:"Global",indx:8},
  OTHER:{name:"Aggregate of Remaining Flows",dg:"Both",indx:9}
}
var xwalkLeg = {"US":["WSC","NE","ENC","PA"],"Global":["AS","EU","AF","LA"]};
var USREGIONS = {"WSC":1,"ESC":1,"SA":1,"NE":1,"ENC":1,"WNC":1,"MO":1,"PA":1}

/////tracking & state variables
d3.select("div#flowDiagramWrap").style({"height":"1100px","width":"950px"}) //EDIT #2 -- match the wrapper width to container el
var SVGDetail = d3.select("svg#flowDiagram").attr({"height":1100,"width":950});  // .attr("transform","translate(1025,0)"); //950 + 75 margin
var mainSVG = d3.select("svg#mainSVG").attr("width", "990px").attr("height", "1100px");

//detailed flow layers
var gPaths = SVGDetail.append("g").attr("transform","translate(0,70)");
var gEnterRect = gPaths.append("svg:clipPath").attr("id","enterClip").append("rect").attr("id","enterClipRect");
var gExitRect = gPaths.append("svg:clipPath").attr("id","exitClip").append("rect").attr("id","exitClipRect");
var gDistro = SVGDetail.append("g").attr("transform","translate(0,70)");
var gSource = SVGDetail.append("g").attr("transform","translate(0,70)").append("g").attr("transform","translate(0,50)");

gDistro.append("text").attr("id","focusMetroTextA").classed("grayNote",true).attr("y",23);
gDistro.append("text").attr("id","focusMetroTextB").classed("grayNote",true).attr("y",38);
//gDistro.append("text").attr("id","focusMetroTextC").classed("grayNote",true).attr("y",45);

gSource.append("path").attr("id","focusMetro").attr("shape-rendering","crispEdges");
gSource.append("path").attr("id","focusMetroRect");
gSource.append("path").attr("id","focusMetroMeasure");
gSource.append("text").attr("id","focusMetroText0");
gSource.append("text").attr("id","focusMetroText1");
//var pathHover = gSource.append("path").style({"fill":"#ffffff","stroke-width":"1px","stroke":"#ffffff","opacity":0.5,"pointer-events":"none"});
var textBack = SVGDetail.append("rect").attr({"x":755,"y":68,"height":1005,"width":195}).style({"fill":"url(#linGradient)","pointer-events":"none"});
var gTexts = SVGDetail.append("g").attr("transform","translate(0,70)");

var ready = false;
var selectedMetro = null;
var selectedCommDF = null;
var selectedCommCH = null;
var selectMenu; //places select menu
var selectMenuC1; //commodities - for chord diagram
var selectMenuC2; //commodities - for detailed flows
var focusLeft = true;

var places_index; //index value of currently selected place -- sync with chord?
var comm_index; //index value of currently selected commodity
var chordCache = {}; //cache of chord diagram flows data
var flowCache = {}; //cache of detailed flows data
var H = 900; //Height of detailed flows diagram
var W = 950; //Width of both diagrams
var SPACE = 5; //space between detailed flows

//Chord SVG
var allChords; //pointer to <g> of chords
var smallChords;
var bigChords;
var chordFocus = false;
var H_chord = 1050 //Height of chord diagram
var innerRadius = Math.min(W, H_chord) * .34;
var outerRadius = innerRadius * 1.05;
d3.select("g#chordDiagram").attr("transform", "translate(" + (W+40)/2 + "," + ((H_chord / 2)+50) + ")");
var SVGChords = d3.select("g#cdChords");
var SVGArcs = d3.select("g#cdArcs");
var SVGChordAnno = d3.select("g#cdAnno");

$("#FNWrap").parent().css("overflow","visible");

//DEAL WITH BROWSER SPECIFIC SVG PERFORMANCE ISSUES
var psOn = false; //"performance scroll" on hides the smallest flows on scroll 
var psB;
var enablePerformanceToggle = function(){
  psB = mainSVG.append("g").attr("transform","translate(970,100)");
  var button = psB.append("rect").attr({"width":"280","height":"55","x":"-260","y":"-15"}).style({"cursor":"pointer","fill":"#ffffff"});
  psB.append("text").text("Currently showing the 200 largest trade").attr({"text-anchor":"end","class":"gray100"});
  psB.append("text").text("flows to optimize browser performance").attr("dy","1.25em").attr({"text-anchor":"end","class":"gray100"});
  psB.append("text").text("Click here to reveal all trade flows").attr("dy","3em").attr({"text-anchor":"end","class":"gray100"});
  button.on("mousedown",function(){

    psOn = false;
    if(smallChords){
      psB.style("display","none");
      smallChords.style("visibility","visible");
    }
  });
}

//Browser detection
var chromeBrowser = false;
try{var chromeBrowser = navigator.userAgent.toLowerCase().search("chrome") > -1;}
catch(e){var chromeBrowser = false;}

//non-chrome browsers have jittery scrolling
if(!chromeBrowser){
  psOn = true;
  enablePerformanceToggle();
  $(window).on("scroll",function(){
    if(smallChords && !psOn && !chordFocus){
      psOn = true;
      psB.style("display","inline");
      smallChords.style("visibility","hidden");
    }
  });
}
//////

//////DRAW CHORD DIAGRAM
var drawChords = function(data,commGroup){
  var matrix = data.data;
  var dLabels = data.places;
  var dMaxes = data.max;
  
  var chord = d3.layout.chord()
    .padding(.0075)
    .sortChords(d3.ascending)
    .matrix(matrix);
    //.sortGroups(d3.descending)
    //.sortSubgroups(d3.descending)

  var arcRefs = {};
  var arcColor = function(i){
    var region = dLabels[i].CensusDiv;
    var col = colors(xwalk[region].indx);
    return region ? col : "#d1d1d1";
  }
  var arcs = SVGArcs.selectAll("path.borderArc").data(chord.groups());
  arcs.exit().remove();
  arcs.enter().append("path").attr("class","borderArc");
  arcs.style("fill", function(d) {
      arcRefs[d.index] = this; //store refs for easy retrieval later (to sync with text hover)
      return arcColor(d.index);
    })
    .style("stroke-width","0px")
    .style("stroke","#ffffff")
    .attr("d", d3.svg.arc().innerRadius(innerRadius).outerRadius(outerRadius));
    
  arcs.on("mousedown", groupClick)
    .on("mouseover",function(){d3.select(this).transition().duration(0).style("opacity",0.5)})
    .on("mouseout",function(){d3.select(this).transition().duration(0).delay(20).style("opacity",1)})


  var r2o = d3.interpolateRgb("#d7dde8","#757f9a");

  var MAX = d3.max(dMaxes);

  allChords = SVGChords.selectAll("path.chord").data(chord.chords());

  allChords.exit().remove();
  allChords.enter().append("path").attr("class","chord");
  allChords.attr("d", d3.svg.chord().radius(innerRadius))

  var len = allChords[0].length;
  allChords.classed("smallFlow",function(d,i){return i<(len-200) ? true : false});
  allChords.classed("bigFlow",function(d,i){return i>=(len-200) ? true : false});

  var chordReset = function(){
    smallChords = SVGChords.selectAll("path.smallFlow");
    bigChords = SVGChords.selectAll("path.bigFlow");
    allChords.style("display","inline"); //group clicks use the display property to turn on/off

    if(psOn){
      smallChords.style("visibility","hidden");
      bigChords.style("visibility","visible"); //necessary when chordReset is called after transitioning between commodities
      if(psB){psB.style("display","inline");}
    }
    else{
      allChords.style("visibility","visible"); 
    }

    allChords
    .style("fill", function(d){
        var r = d.source.value/MAX + 0.15;
        return r>=1 ? r2o(1) : r2o(r);
      })
    .style({"stroke-width":"0px","opacity":1});
  }
  chordReset();

  


//CHORD LABELS
  var labelPos = function(d,i,a) {
    var pos = d.endAngle - ((d.endAngle - d.startAngle)/2);
    var deg = (pos * 180 / Math.PI)
    var rot = deg-90;
    var name = dLabels[i].fullname; //CHECK -- INTEGRITY
    var div = dLabels[i].CensusDiv;
    return {rot:rot,deg:deg,index:d.index,name:name,div:div}
  }
  var labelData = chord.groups().map(labelPos);

  var labelG = SVGChordAnno.selectAll("g.borderLabel").data(labelData);
  labelG.exit().remove();
  labelG.enter().append("g");
  labelG.attr("transform",function(d) {
        return "rotate(" + d.rot + ")" + "translate(" + outerRadius + ",0)";
    })
    .attr("class","borderLabel")

  labelG.selectAll("text").remove();
  var labelText = labelG.append("text");

  labelText.text(function(d,i){return d.name})
           .attr("x", 8)
           .attr("dy", "0.25em")
           .attr("class","selectable")
           .attr("transform", function(d) { return d.deg > 180 ? "rotate(180)translate(-16)" : null; })
           .style("text-anchor", function(d) { return d.deg > 180 ? "end" : null; })
           .style("fill",function(d){
            var col = colors(xwalk[d.div].indx);
            return d3.rgb(col).darker(2)
           })
           .on("mousedown",groupClick)
           .on("mouseover",function(d,i){
              var arc = d3.select(arcRefs[d.index]);
              arc.style("opacity",0.5)
           })
           .on("mouseout",function(d,i){
              var arc = d3.select(arcRefs[d.index]);
              arc.transition().style("opacity",1);
           });


  //inner ring border
  var chordBorder = SVGChordAnno.selectAll("circle.chordBorder").data([1]);
  chordBorder.exit().remove();
  chordBorder.enter().append("circle").attr("class","chordBorder");
  chordBorder.attr({"cx":"0","cy":"0",r:innerRadius}).style({"stroke-width":"3px","stroke":"#ffffff","fill":"none"});
  
  //
  chordFocus = false; //is the diagram focused
  var resetButtonGroup = d3.select("#chordResetButton").attr("transform","translate(980,35)").style("visibility","hidden");
      resetButtonGroup.select("path").style({"fill":"rgb(9, 98, 186)","stroke-width":"0px","pointer-events":"none"}).attr("d","m -150,8 4.5,5 5,-5 -3,0 -3,-8 -8,-3 -8,3 -3,8 3,8 8,3 8,-3 -3,-2 -5,2 -6,-2 -2,-6 2,-6 6,-2 6,2 2,6 z");
      resetButtonGroup.select("text").text("Reset Diagram").attr({"x":-135,"y":"12"}).style({"text-anchor":"start","font-size":"11px","pointer-events":"none"});
      resetButtonGroup.select("rect").attr({"width":"200px","height":"35px","x":"-200","y":"-10"})
        .style({"fill":"#ffffff","stroke-width":"1px","cursor":"pointer"})
        .on("mousedown",function(){
          chordClickDirection.style("visibility","visible");
          resetButtonGroup.style("visibility","hidden");
          chordReset();
          chordFocus = false;
        });

  var chordClickDirection = d3.select("#chordClickDirection").style("visibility","visible"); //show text

  function groupClick(d) {
    //RESET BUTTON
    if(!chordFocus){
      chordClickDirection.style("visibility","hidden"); //hide text
      resetButtonGroup.style("visibility","visible"); //show reset button
      chordFocus = true;
    }

    var CHORDS = SVGChords.selectAll("path.chord");
    d3.event.stopPropagation();
    var I = d.index;
    var MAX = dMaxes[I]; //-- relative to metro's flows

    CHORDS.style("display",function(d){
      return d.source.index === I || d.target.index === I ? "inline" : "none"; 
    })
    .style("fill",function(d){
      return d.source.index===I ? arcColor(d.target.index) : arcColor(d.source.index);
    })
    .attr("stroke", function(d){
      return d.source.index===I ? arcColor(d.target.index) : arcColor(d.source.index);
    })
    .style("stroke-width","0.5px")
    .style("opacity",function(d,i){
      var ratio = d.source.value/MAX + 0.15;
      return ratio > 1 ? 1 : ratio;
    })
    .style("visibility","visible"); //all should be visible
    ;

    if(psB){psB.style("display","none");} //all chords are seen when a group is focused

    var place_id = dLabels[I].Geo_ID;
    triggerPlaceUpdate(place_id); //sync the flow diagram by place -- other sync functions are for commodities
  };

d3.select("h3#chordDiagramTitle").text("Overview of the Goods Trade Network for " + commGroup.Commodity_Group + " Involving U.S. Markets");
if(commGroup.Group_ID===14 || commGroup.Group_ID===15){
  d3.select("p#chordDiagramText").html("This diagram shows trade flows of <span style='font-weight:bold'>" + commGroup.Commodity_Group.toLowerCase() + "</span> between the 75 largest domestic markets markets for these goods. A market's size is determined by its combined exports and imports to/from other markets in the United States.")
}
else{
  d3.select("p#chordDiagramText").html("This diagram shows trade flows of <span style='font-weight:bold'>" + commGroup.Commodity_Group.toLowerCase() + "</span> between the 75 largest domestic markets and 25 largest global markets for these goods. A market's size is determined by its combined exports and imports to/from other markets in the United States.")
}

} //END DRAW CHORDS

/////////////////////////////////////////////////////////////////
//DETAILED FLOWS
var dataTransform = function(flowData){
  //summary data
  var flow = flowData.flows;
  var newH = H - (SPACE*(flow.length-1));
  var range = d3.extent(flow,function(d,i,a){return d.val});
  var sum = d3.sum(flow,function(d,i,a){return d.val});
  var max = range[1];
  var Y = d3.scale.linear().domain([0,1]).range([0,newH]); 
  var cum = 0;
  
  //function to transform each element
  var mapper = function(d,i,a){
    var h = Y(d.val/sum);
    var b = cum; 
    cum = cum + h + SPACE;
    var col = colors(xwalk[d.div].indx);
    return {nm:d.nm, id:d.id, div:d.div, val:d.val, height:h, top:b, bot:cum, col:col, pos:i*3}; 
  }

  var flowObj = {
                  flows:flow.map(mapper),
                  focusGeo:flowData.focusGeoName[0],
                  commNM:flowData.commNM[0],
                  focusGeoTot:flowData.focusGeoVal[0],
                  allGeoMax:flowData.allGeoMax[0]
                };

  return flowObj;
}

var dFmt0 = d3.format("$,.0f");
var dFmt1 = d3.format("$,.1f");
var dFmt3 = d3.format("$,.3f");
var dFmt = function(d){
  if(d>1000){
    return dFmt3(d/1000);
  }
  else{
    return dFmt1(d);
  }
}

var ttipDisabled = false;
function flowTT(){
  var ttipNode = document.getElementById("#flowToolTip");
  var ttip = d3.select("#flowToolTip").style({"left":"-145px","pointer-events":"none","position":"absolute","z-index":"0","width":"190px","padding":"10px 10px 10px 10px","top":"0px","left":"0px","overflow":"visible","display":"none","background":"none"});
  var ttipSVG = ttip.append("svg").attr({"width":"220px","height":"150px"}).style({"position":"absolute","top":"0px","left":"0px"});
  var ttipArrow = ttipSVG.append("path").attr("d","M1,1 l209,0 l0,13 l8,8 l-8,8 l0,100 l-209,0z M21,93 l170,0").attr({"fill":"#ffffff","stroke":"blue","stroke-width":"1px","shape-rendering":"crispEdges","fill-opacity":0.85});
  var ttipG = ttipSVG.append("g");

  var tipTimer;
  var showtip = function(d,thiz){
    clearTimeout(tipTimer);
    if(ttipDisabled){
      ttip.style("display","none");
      return null;
    }
    ttip.style("display","block");
    var T = ["Value of Trade Between",selectedMetro.fullname,"and",d.nm, (d.val>1000 ? dFmt3(d.val/1000)+" billion" : dFmt1(d.val)+" million")]
    var text = ttipG.selectAll("text").data(T);
    text.exit().remove();
    text.enter().append("text");
    text.attr({"text-anchor":"middle","x":105})
    .attr("y",function(d,i){
      if(i==0){return 27}
      else if(i<=3){return 32 + i*16}
      else {return 52 + i*16}
    })
    .style("font-weight",function(d,i){
      return i==0 || i==4 ? "bold" : "normal";
    })
    .attr("font-style",function(d,i){
      return i==1 || i==3 ? "italic" : "normal";
    })
    .style("font-size",function(d,i){
      if(i==0){return "13px"}
      else if(i<=3){return "13px"}
      else {return "15px"}
    })
    .text(function(d,i){return d});

    ttipArrow.attr("stroke",d.col);
    var coord = [950-215-200,d.top+(0.5*d.height)-22];
    var x = Math.round(coord[0]) + "px";
    var y = Math.round(coord[1] + 70) + "px"; //account for the translate of the base <g>
    ttip.style({"left":x, "top":y});

    //console.log(ttipG.node().getBoundingClientRect());
  }

  var hidetip = function(){
    tipTimer = setTimeout(function(){ttip.style("display","none");},750);
  }
  return {show:showtip, hide:hidetip}
}
var ttipMethods = flowTT();


var ILLUSTRATE = function(flowData,sourceCode){
  if(!ready){return null}
  if(!flowData){
    alert("Data error, reload.")
    return;
  }
  ttipDisabled = true;
  ttipMethods.hide();

  var flow = flowData.flows;

  var sourceHeight = 152;
  var Yleft = d3.scale.linear().domain([0,flowData.allGeoMax]).range([(H-200-sourceHeight),50+(sourceHeight/4)]); 
  var ticks = Yleft.ticks(10);

  var distro = gDistro.selectAll("path").data(ticks);
  var distroText = gDistro.selectAll("text.axisText").data(ticks);
  distro.exit().remove();
  distro.enter().append("path");
  distro.attr("d",function(d,i){
    var y = Yleft(d);
    return "M0,"+y+" l10,0"
  }).attr({"stroke-width":"1px","stroke":"#646464","shape-rendering":"crispEdges"})
  distroText.exit().remove();
  distroText.enter().append("text").attr("class","axisText");
  distroText.text(function(d,i){
    if(d==0) {return "$0"}
    else if(d >= 1000) {return d < 10000 ? dFmt1(d/1000) + " bil." : dFmt0(d/1000) + " bil."}
    else {return dFmt0(d) + " mil."}
  })
  .attr({"x":"13","dy":4})
  .attr("y",function(d,i){
    return Yleft(d);
  })
  .style({"font-size":"11px"})
  .classed("gray100",true);

  //Bezier curve parameters  
  var xLeft = 90;
  var xRight = 750
  var x0 = Math.round((xRight-xLeft)/2);
  var x1 = x0;

  //Origin block
  var totVal = flowData.focusGeoTot;
  var sourceTop = Yleft(totVal)-(sourceHeight/4); //the cutout should indicate the value
  
  try{
    var sourceCol = colors(xwalk[places_index.filter(function(d,i,a){return d.Geo_ID===sourceCode})[0].CensusDiv].indx);
  }
  catch(e){
    var sourceCol = "#d1d1d1";
  }

  //TITLING
  var oneEighth = sourceHeight/8;
  d3.select("h3#myMetroFlowTitle").text("Trade of " + flowData.commNM + " between " + flowData.focusGeo + " and its Largest Trading Partners");
  d3.select("p#myMetroFlowText").html("This diagram shows the largest trade flows (imports plus exports) by dollar value of <span style='font-weight:bold'>" + flowData.commNM.toLowerCase() + "</span> between <span style='font-weight:bold'>" + flowData.focusGeo + "</span> and its largest trading partners for this commodity group.")
  var focus = gSource.select("path#focusMetro").attr("d","M0,0 l88,0 l0," + sourceHeight + " l-88,0z") //l0," + (0-(6*oneEighth)+2) + " l6,0 l0,-4 l-6,0" );
  var focusCover = gSource.select("path#focusMetroRect").attr({"fill":"url(#linGradient2)","d":"M0,"+oneEighth+" l88,0 l0,"+(oneEighth*2)+" l-88,0 l0,-"+(oneEighth-1)+" l10,0 l0,-2 l-10,0z","shape-rendering":"crispEdges"})
  
  var focusTextA = gDistro.select("text#focusMetroTextA").text("Value of Goods Traded (Imports Plus Exports)");
  var focusTextB = gDistro.select("text#focusMetroTextB").text(flowData.commNM);
  //var focusTextC = gDistro.select("text#focusMetroTextC").text(flowData.commNM);
  
  var focusText0 = gSource.select("text#focusMetroText0").text(dFmt(totVal)).style({"font-size":"15px","font-weight":"bold","fill":d3.rgb(sourceCol).darker(2)}).attr({"y":oneEighth+18,"x":80,"text-anchor":"end"});
  var focusText1 = gSource.select("text#focusMetroText1").text(totVal > 1000 ? "billion" : "million").style({"font-style":"italic","font-size":"12px","font-weight":"normal","fill":d3.rgb(sourceCol).darker(2)}).attr({"y":oneEighth+18+13,"x":78,"text-anchor":"end"});
  focus.style("fill",sourceCol);
  //END ORIGIN BLOCK

  var mergeFunc = function(d,i){return d.id} 
  var basePath = function(sourceY){
    sourceY = !!sourceY ? sourceY : 150;
    var s = "M" + xLeft + "," + sourceY +
          "C" + x0 + "," + sourceY + 
          " " + x1 + "," + (H-5) + 
          " " + xRight + "," + (H-5) +
          "l200,0" +
          "l0" + "," + 5 +
          "l-200,0" +
          "C" + x1 + "," + H +
          " " + x0 + "," + sourceY + 
          " " + xLeft + "," + sourceY ;
    return s;
  }  

  gPaths.selectAll("path.exiting").remove(); //if the "end" function gets interrupted below
  gTexts.selectAll("text.exiting").remove();

  var flows = gPaths.selectAll("path.activeFlow").data(flow,mergeFunc);
  var text = gTexts.selectAll("text.label").data(flow,mergeFunc);

  var exitSelect = flows.exit().classed("exiting",true).classed("activeFlow",false);
  var exitSelectText = text.exit().classed("exiting",true);
  exitSelectText.transition().duration(0).style("fill","#ffffff"); //
  
  //previously entering elements that are now exiting should be removed immediately -- if not, they may be visible when reassigning the clip-path
  var problematic = exitSelect.filter(function(d,i){return d3.select(this).classed("entering");}).remove();
  var problematicText = exitSelectText.filter(function(d,i){return d3.select(this).classed("entering");}).remove(); //this isn't really an issue for the text nodes because they are small, and are immediately set to #ffffff

  gExitRect.attr({"width":W,"height":H,"x":0,"y":0}).transition(0).duration(0).attr("x",0); //critical -- cancels previous transition, anything exiting is visible
  gEnterRect.attr({"width":0,"height":H,"x":0,"y":0}).transition(0).duration(0).attr({"width":0}); //critical -- cancels previous transition, anything entering is hidden

  exitSelect.attr("clip-path","url(#exitClip)"); //set all elements of exit selection to the exit clip path, except those "problematic" (see above) elements whose immediate appearance would be jarring
  exitSelectText.attr("clip-path","url(#exitClip)");

  gExitRect.transition().delay(0).duration(800).attr("x",W).each("end",function(){
    exitSelect.remove();
    exitSelectText.remove();
  });

  var enterSelect = flows.enter().append("path").attr({"clip-path":"url(#enterClip)"}).classed("activeFlow entering",true)
  .style({"stroke-width":"1px","stroke":"#ffffff","fill":"#ffffff"})
  .attr("d",function(d){
    return basePath(sourceTop+sourceHeight);
  }).style("fill",function(d,i){
    return d.col;
  })
  .style("stroke",function(d,i){
    return d.col;
  });//baseline styles only get applied to entering selection -- which is every node at some point

  //flows.style("pointer-events","none") //disable hovering while transitioning

  var enterSelectText = text.enter().append("text").classed("label entering",true)
    .style({"opacity":"1"})
    .style("fill",function(d,i){return d3.rgb(d.col).darker(2)})
    .attr({"x":xRight+10,y:H})
    .text(function(d){
      return d.nm;
    })
    .attr("y",function(d,i){
      var mid = d.top + (0.5*d.height);
      return mid;
    })
    .attr("clip-path","url(#enterClip)"); 

  var stillEntering = gPaths.selectAll("path.entering") //these never finished their enter animation and will eventually need to be "unclipped"
  var stillEnteringText = gTexts.selectAll("text.entering");

  flows.transition().delay(800).duration(1500)
  .attr("d",function(d,i){
    var sourceY = d.pos + sourceTop;
    var s = "M" + xLeft + "," + sourceY +
            "C" + x0 + "," + sourceY + 
            " " + x1 + "," + d.top + 
            " " + xRight + "," + d.top +
            "l200,0" +
            "l0" + "," + d.height +
            "l-200,0" +
            "C" + x1 + "," + (d.bot-SPACE) +
            " " + x0 + "," + sourceY + 
            " " + xLeft + "," + sourceY ;
    return s;
  })

  gSource.transition().delay(800).duration(1500).attr({"transform":"translate(0,"+ (sourceTop-1) + ")"});
  
  gEnterRect.transition().delay(2300).duration(800).attr("width",W).each("end",function(){
    enterSelect.attr("clip-path",null);
    enterSelectText.attr("clip-path",null);
    stillEntering.attr("clip-path",null).classed("entering",false);
    stillEnteringText.attr("clip-path",null).classed("entering",false);
    syncChordDiagram();
    ttipDisabled = false;
    //flows.style("pointer-events","auto") //re-enable hovering
  });

  flows.classed("selectable",function(d,i){
    return d.div in USREGIONS ? true : false;
  })
  .on("mouseover",function(d,i){
    d3.select(this).style("opacity",0.3);
    ttipMethods.show(d,this); //EDIT #4
    //pathHover.attr("d",d3.select(this).attr("d"));
  })
  .on("mouseleave",function(d,i){
    d3.select(this).style("opacity",1);
    ttipMethods.hide();
  }); //attach

  flows.filter(function(d,i){
    return d3.select(this).classed("selectable");
  })
  .on("mousedown",function(d,i){
    var id = d.id;
    var f = places_index.filter(function(d,i,a){
      return d.Geo_ID === id;
    })
    var currentIndex = selectMenu.node().selectedIndex;
    try{
      var I = places_index.indexOf(f[0]);
      selectMenu.node().selectedIndex = I;
      UPDATE();
    } 
    catch(e){
      selectMenu.node().selectedIndex = currentIndex; //reverse any change
      UPDATE();
    }
  })

  /*
  .on("mouseout",function(d,i){
    d3.select(this).style("fill",d.col);
  })  
  ;*/

// http://jsfiddle.net/sxtnftsh/1/
  text.transition().delay(800).duration(1500)
  .attr("y",function(d,i){
    var mid = d.top + (0.5*d.height);
    return mid;
  })
  
  /*.each("end",function(d,i){
    if(i==0){
      tFinish.text = true;
      if(tFinish.paths){syncChordDiagram();}
    }
  })*/ //just do this on flow end
  
}

////////////////////////////////////////////////////////////////////LOAD IN METADATA
d3.json(DATAREPO + "index.json",function(error,data){
  if(data){
    places_index = data.places;
    comm_index = data.commodities;

    selectMenu = d3.select("#metroSelect");
    selectMenuC1 = d3.select("#commSelect1"); //for chord diagram
    selectMenuC2 = d3.select("#commSelect2");

    selectMenu.selectAll("option").data(places_index).enter().append("option")
    .attr("value",function(d){
      return d.Geo_ID;
    })
    .text(function(d){
      return d.fullname;
    })

    selectMenuC1.selectAll("option").data(comm_index).enter().append("option")
    .attr("value",function(d){
      return d.Group_ID;
    })
    .text(function(d){
      return d.Commodity_Group;
    })

    selectMenuC2.selectAll("option").data(comm_index).enter().append("option")
    .attr("value",function(d){
      return d.Group_ID;
    })
    .text(function(d){
      return d.Commodity_Group;
    })


    selectMenu.on("change",function(d,i){
      selectMenu.node().blur();
      UPDATE();
    })

    selectMenuC2.on("change",function(d,i){
      selectMenuC2.node().blur();
      UPDATE();
    })

    selectMenuC1.on("change",getDrawChords);
    
    //INITIALIZATION
    ready = true; //menus are set up and ready
    getDrawChords(); //draw chord diagram
    UPDATE(); //draw flows diagram
  }
})
/////////////////////////////

//syncing the detailed flows to the selected comm index of the chord diagram
var syncDetailedFlows = function(){
  if(!ready){return null} //ready indicates the menus have completed loading
  
  var c = selectMenuC1.node().selectedIndex; //the selected commodity on the chord diagram

  var otherMenu = selectMenuC2.node(); //menu for flows diagram
  if(c !== otherMenu.selectedIndex){
    otherMenu.selectedIndex = c; //sync
    UPDATE(); //re-draw
  }
}

var triggerPlaceUpdate = function(geoCode){
  if(!ready){return null} //ready indicates the menus have completed loading
  
  var f = places_index.filter(function(d,i,a){
    return d.Geo_ID === geoCode;
  })

  var currentIndex = selectMenu.node().selectedIndex;
  try{
    var I = places_index.indexOf(f[0]);
    selectMenu.node().selectedIndex = I;
    UPDATE();
  } 
  catch(e){
    selectMenu.node().selectedIndex = currentIndex; //reverse any change
    UPDATE();
  }
}

//syncing the chord diagram to the selected index of the detailed flows diagram
var syncChordDiagram = function(){
  if(!ready){return null} //ready indicates the menus have completed loading

  var c = selectMenuC2.node().selectedIndex; //selected commodity on the flow diagram

  var otherMenu = selectMenuC1.node(); //menu for chord diagram
  if(c !== otherMenu.selectedIndex){
    otherMenu.selectedIndex = c; //sync
    getDrawChords(); //re-draw
  }
}

//GET/DRAW COMMODITY DATA FOR CHORDS
var getDrawChords = function(d,index){
  var node = selectMenuC1.node();
  node.blur();
  var i = node.selectedIndex;
  selectedCommCH = comm_index[i];
  var code = selectedCommCH.Group_ID;
  var nm = selectedCommCH.Commodity_Group;
  if(i in chordCache){
    drawChords(chordCache[i],selectedCommCH);
    syncDetailedFlows();
  }
  else{
    d3.json(DATAREPO + "chord_data/bigMatrix_" +code+".json",function(error,data){
      if(data){
        chordCache[i] = data;
        drawChords(data,selectedCommCH);
      }
      syncDetailedFlows();
    }); 
  }
}

//The UPDATE function updates the detailed flow data, prepping it for the ILLUSTRATE function
function UPDATE(){
  if(!ready){return null} //ready indicates the menus have completed loading
  var metroFlow;

  var i = selectMenu.node().selectedIndex;
  selectedMetro = places_index[i];
  var code = selectedMetro.Geo_ID;
  var nm = selectedMetro.fullname;

  var c = selectMenuC2.node().selectedIndex;
  selectedCommDF = comm_index[c];
  var commName = selectedCommDF.Commodity_Group;
  var commID = "comm"+selectedCommDF.Group_ID;

  if(code in flowCache){
    if(commID in flowCache[code]){
      metroFlow = flowCache[code][commID];
    }
    else{
      flowCache[code][commID] = dataTransform(flowCache[code].raw[commID]);
      metroFlow = flowCache[code][commID];
    }
    ILLUSTRATE(metroFlow,code);
  }
  else{
    d3.json(DATAREPO+"detailed_flows/" +code+".json",function(error,data){
      if(error){
        metroFlow = null;
      } else{
        flowCache[code] = {raw:data};
        flowCache[code][commID] = dataTransform(data[commID]);
        metroFlow = flowCache[code][commID];
      }
      ILLUSTRATE(metroFlow,code);
    })
  }

}

/////////////////////////////////////////////////////////////LEGEND
function drawLegend(){
  var legend_outer = d3.select("g#legendGroup");
  var legend = legend_outer.append("g").attr("id","legendInner")
  var legendBack = legend.append("rect").style("fill","#ffffff");

  var sublegend = legend.selectAll("g").data([xwalkLeg.US,xwalkLeg.Global]).enter().append("g").attr("id",function(d,i){return "sublegend" + i});
  var subG = sublegend.selectAll("g").data(function(d,i){
    return d;
  }).enter().append("g");

  var itemText = subG.append("text").text(function(d,i){
    var nm = xwalk[d].name;
    return nm;
  }).attr("dx","15px")

  var cumWidth = -40;
  subG.attr("transform",function(d,i){
    var br = this.getBoundingClientRect();
    var w = br.right - br.left;
    var pad = i===0 ? 40 : 15;
    var x = cumWidth + pad;
    cumWidth = w + x + 15; //15px on the right
    return("translate("+(x)+",0)");
  });

  subG.append("rect")
    .attr({"x":"0","y":"-10","width":"12","height":"12"})
    .style("fill",function(d,i){return colors(xwalk[d].indx)})

  subG.filter(function(d,i){
    return i===0;
  }).append("text").attr("dy","-18px").text(function(d,i){
    return d in USREGIONS ? "U.S. REGIONS" : "GLOBAL REGIONS"
  }).style({"font-weight":"bold"});

  var legendLeft = (W-cumWidth)/2;
  //legendLeft = W-cumWidth;
  legendLeft = 25;
  legend_outer.attr("transform","translate("+ legendLeft + ",50)");
  legendBack.attr({"x":-10,"y":-40,"height":50,"width":cumWidth+20,"opacity":"0.85"})

  var textDirection = d3.select("#chordClickDirection").attr({"transform":"translate(970,35)"});
  textDirection.append("text").attr({"text-anchor":"end"}).text("Click on the perimeter of the circle below to view");
  textDirection.append("text").attr({"text-anchor":"end"}).attr("dy","1.25em").text("trade flows to/from the selected geography");

  var flowTextDirection = d3.select("#flowDiagram").append("g").attr({"transform":"translate(945,35)"});
  flowTextDirection.append("text").attr({"text-anchor":"end"}).text("Use the menu above or click on any domestic geography");
  flowTextDirection.append("text").attr({"text-anchor":"end"}).attr("dy","1.25em").text("below to view trade flows to/from the selected geography");

  SVGDetail.append("use").attr({"xlink:href":"#legendInner","x":5,"y":50}); //copy the legend 
}
drawLegend();


/*
var moveSlider = {
  sliderRef:d3.select("#slider"),
  slideLeft:function(){
    if(!ready){return null}
    var focusLeft = false;
    var thiz = this.sliderRef;
    var l = parseInt(thiz.style("left"));
    thiz.classed("slidingRight",false); //if slideLeft interrupts slideRight, remove the class
    if(thiz.classed("slidingLeft") || l===-1025){
      return null;
    }
    else{
      thiz.classed("slidingLeft",true);
      allChords.style("display","none");

      thiz.transition().duration(1000).style("left","-1025px").each("end",function(){
        thiz.classed("slidingLeft",false);
      });
    }
  },
  slideRight:function(){
    if(!ready){return null}
    var focusLeft = true;
    var thiz = this.sliderRef;
    var l = parseInt(thiz.style("left"));
    thiz.classed("slidingLeft",false); //if slideRight interrupts slideLeft, remove the class
    if(thiz.classed("slidingRight") || l===0){
      return null;
    }
    else{
      thiz.classed("slidingRight",true);
      syncChordDiagram(selectMenuC2.node().selectedIndex); //sync the chord diagram to the commodity of the flows diagram
      allChords.style("display","none");
      thiz.transition().duration(1000).style("left","0px").each("end",function(){
        thiz.classed("slidingRight",false);
        allChords.style("display","inline");
      });
    }
  }
}

d3.select(window).on("keydown",function(){
  var key = d3.event.keyCode;
  if(key==39){moveSlider.slideLeft();}
  else if(key==37){moveSlider.slideRight();}
})*/

</script>

</body>
</html>